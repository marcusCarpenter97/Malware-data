import os
import shutil
import backend
from backend import Batch

dataset_path = "Malware-dataset/"

cf = backend.open_json(Batch.conf_path)
fp = backend.open_json(Batch.file_paths)

for batch_name in cf: 
    data_dir = f"CAPE_{batch_name}"
    batch_dir = os.path.join(dataset_path,data_dir)
    os.mkdir(batch_dir)
    for report_num in range(cf[batch_name]["start"], cf[batch_name]["stop"]+1):
        report_path = os.path.join(fp["cape_analysis_dir"], str(report_num), fp["cape_result_file"])
        report_contents = backend.open_json(report_path)

        try:
            md5 = report_contents.get("target", {}).get("file", {}).get("md5", None)
        except AttributeError as err:
            print(err, report_path)
            continue


        dest_path = os.path.join(batch_dir, f"{md5}.json")

        try:
            shutil.copy(report_path, dest_path)
        except FileNotFoundError as err:
            print(err)
